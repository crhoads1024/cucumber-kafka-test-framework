# ============================================================
# CI/CD Pipeline - Enterprise Test Framework
#
# PIPELINE FLOW:
#   generate-data -> functional-tests (parallel with) contract-tests -> performance-tests
#
# Each stage runs in containers. Data is shared via artifacts.
# Performance tests only run if functional + contract pass.
# ============================================================

name: Test Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      perf_threads:
        description: 'JMeter thread count'
        default: '50'
      perf_duration:
        description: 'JMeter duration (seconds)'
        default: '300'

env:
  JAVA_VERSION: '17'

jobs:

  # ===== STAGE 1: Generate Synthetic Test Data =====
  generate-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Build data generator
        run: mvn package -pl shared,data-generator -am -DskipTests -q

      - name: Generate test data (CI profile)
        run: |
          mvn exec:java -pl data-generator \
            -Dexec.mainClass="com.enterprise.testing.datagen.DataGeneratorMain" \
            -Dexec.args="--profile ci --output-dir ./generated-data"

      - name: Upload generated data
        uses: actions/upload-artifact@v4
        with:
          name: test-data
          path: ./generated-data/
          retention-days: 1

  # ===== STAGE 2a: Functional + Database Tests =====
  functional-tests:
    needs: generate-data
    runs-on: ubuntu-latest

    services:
      kafka:
        image: confluentinc/cp-kafka:7.6.0
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        ports:
          - 9092:9092

      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - uses: actions/download-artifact@v4
        with:
          name: test-data
          path: ./generated-data/

      - name: Initialize database
        run: psql -h localhost -U testuser -d testdb -f docker/init-db.sql
        env:
          PGPASSWORD: testpass

      - name: Run functional tests
        run: |
          mvn test -pl functional-tests \
            -Dcucumber.filter.tags="@functional" \
            -DAPP_BASE_URL=http://localhost:8080 \
            -DKAFKA_BOOTSTRAP_SERVERS=localhost:9092 \
            -DDB_URL=jdbc:postgresql://localhost:5432/testdb

      - name: Run database tests
        run: |
          mvn test -pl functional-tests \
            -Dcucumber.filter.tags="@database" \
            -DDB_URL=jdbc:postgresql://localhost:5432/testdb

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: functional-test-reports
          path: functional-tests/target/cucumber-reports/

  # ===== STAGE 2b: Contract Tests (parallel) =====
  contract-tests:
    needs: generate-data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Run contract tests
        run: mvn test -pl contract-tests

      - name: Upload Pact contracts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pact-contracts
          path: contract-tests/target/pacts/

  # ===== STAGE 3: Performance Tests =====
  performance-tests:
    needs: [functional-tests, contract-tests]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: test-data
          path: ./generated-data/

      - name: Run JMeter load test
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: perf-tests/test-plans/order-load-test.jmx
          outputReportsFolder: perf-results/
          args: >-
            -Jhost=app-under-test
            -Jthreads=${{ github.event.inputs.perf_threads || '50' }}
            -Jduration=${{ github.event.inputs.perf_duration || '300' }}
            -Jdata.file=../../generated-data/jmeter-users.csv

      - name: Check performance thresholds
        run: python3 perf-tests/scripts/check-perf-thresholds.py perf-results/results.jtl

      - name: Upload performance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-reports
          path: perf-results/
